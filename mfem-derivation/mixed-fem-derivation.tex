\documentclass[letterpaper,12pt]{article}
\usepackage[margin=0.65in]{geometry}
\usepackage{amsmath,amsthm,amsfonts,amssymb}
\usepackage{mathtools}
%\usepackage{algorithm,algpseudocode}
\usepackage{hyperref}
\usepackage{graphicx}
\usepackage{listings}
\usepackage{subcaption}
\usepackage[section]{placeins}
\usepackage{algorithm2e}


\theoremstyle{remark}
\newtheorem{claim}{Claim}

\DeclarePairedDelimiter\abs{\lvert}{\rvert}
\DeclarePairedDelimiter\floor{\lfloor}{\rfloor}
\DeclarePairedDelimiter\ceiling{\lceil}{\rceil}

\usepackage{xcolor}
 
\definecolor{codegreen}{rgb}{0,0.6,0}
\definecolor{codegray}{rgb}{0.5,0.5,0.5}
\definecolor{codepurple}{rgb}{0.58,0,0.82}
\definecolor{backcolour}{rgb}{0.95,0.95,0.92}
\definecolor{violet}{rgb}{0.34, 0.02, 0.54}

\newcommand{\danny}[1]{\textcolor{violet}{\textbf{#1}}}
 
\lstdefinestyle{mystyle}{
    backgroundcolor=\color{backcolour},
    numbers=left,
    commentstyle=\color{codegreen},
    keywordstyle=\color{magenta},
    numberstyle=\tiny\color{codegray},
    stringstyle=\color{codepurple},
    basicstyle=\ttfamily\footnotesize,
    breakatwhitespace=false,         
    breaklines=true,                 
    captionpos=b,                    
    keepspaces=true,                 
    showspaces=false,                
    showstringspaces=false,
    showtabs=false,                  
    tabsize=1
}
 
\lstset{style=mystyle}


\newcommand{\V}{\mathcal{V}}
\newcommand{\HO}{ {H^1(\Omega)} }
\newcommand{\LO}{ {L^2(\Omega)} }
\newcommand{\LG}{ {L^2(\Gamma)} }
\newcommand{\LGin}{ {L^2(\Gin)} }
\newcommand{\LGout}{ {L^2(\Gout)} }
\newcommand{\R}{\mathbb{R}}
\newcommand{\Th}{\mathcal{T}}
\newcommand{\X}{\bar{\mathbf{x}}}
\newcommand{\x}{\mathbf{x}}
\newcommand{\C}{\mathbf{c}}
\newcommand{\s}{\mathbf{s}}
\newcommand{\la}{\mathbf{\lambda}}
\newcommand{\dx}{\delta \x}
\newcommand{\ds}{\delta \s}
\newcommand{\dl}{\delta \la}
\newcommand{\fext}{\mathbf{f}_\text{ext}}
\DeclareMathOperator*{\argmin}{arg\,min} 
\DeclareMathOperator*{\argmax}{arg\,max} 
\newcommand{\El}{E_\Lambda}
\newcommand{\Hx}{ {H_\x} }
\newcommand{\Hs}{ {H_\s} }
\newcommand{\Hsinv}{H_\s^{-1}}
\newcommand{\Hsk}{ {H_{\s_K}} }
\newcommand{\Hskinv}{H_{\s_K}^{-1}}

\newcommand{\gx}{ {\mathbf{g}_\x} }
\newcommand{\gs}{ {\mathbf{g}_\s} }
\newcommand{\res}{ {\mathbf{r}} }
\newcommand{\Jt}{ {\tilde{J}} }


\RestyleAlgo{ruled}
\LinesNumbered

\begin{document}


\title{Mixed FEM stuff}
\date{}
\maketitle

\input{setup.tex}


\input{derivs.tex}
%\input{system_quad.tex}


\subsection{Primal Energy}
For the primal variables, we take the quadratic approximation of the full energy by only taking variations in $\x$ and $\s$. Also we define $c_K(\x,\s) = W_K \s_K - J_K \x$ where $W_K$ is a function of $\x$. This means that $\El^K(\x,\s,\la) = \la_K \cdot c_K(\x,\s)$. We then have a quadratic approximation of the entire energy that takes the form

\begin{align*}
E(\x,\s) \approx \tilde{E}(\x,\s,\la^k) &= E_M(\x^k) + E_\Psi(\s^k) + E_\kappa(\x, \s) - \El(\x^k,\s^k,\la^k) \\
&+ 
\dx^T \left(
	\frac{\partial E_M}{\partial \x} 
 +  \frac{\partial E_\kappa}{\partial \x} 
 -  \frac{\partial \C}{\partial \x} \la^k \right) & \\
&+ \ds^T \left(
	\frac{\partial E_\Psi}{\partial \s} 
+  \frac{\partial E_\kappa}{\partial \s} 
 -  \frac{\partial \C}{\partial \s} \la^k \right)  & \\
& + \dx^T \left(
  \frac{\partial^2 E_\kappa}{\partial \x \partial \s}
 - \frac{\partial}{\partial \x} \left(\frac{\partial \C}{\partial \s} \la^k\right) \right)\ds & \\
& + \frac{1}{2} \ds^T \left(
 \frac{\partial^2 E_\kappa}{\partial \s^2}
 + \frac{\partial^2 E_\Psi}{\partial \s^2}
 \right)\ds & \\
& + \frac{1}{2}\dx^T \left(\frac{\partial^2 E_M}{\partial \x^2} 
+ \frac{\partial^2 E_\kappa}{\partial \x^2}
- \frac{\partial}{\partial \x} \left(\frac{\partial \C}{\partial \x} \la^k\right)
\right)\dx & \\
\end{align*}


Now to setup our system of equations, we differentiate our energy with respect to the $\delta$-variables and set equal to zero. We switch back to vector notation and make $K$ a subscript to simplify the notation.

\subsection{Equation for $\dx$}
Last we differentiate $\tilde{E}$ with respect to $\dx$ (neglecting the $\frac{\partial^2 \C_K}{ \partial \x^2}$ term for now):

\begin{equation}
\begin{split}
\frac{\partial \tilde{E}}{\partial \dx} &=
 \frac{\partial E_M}{\partial \x} + \frac{\partial E_\kappa}{\partial \x} -  \frac{\partial \El}{\partial \x} 
 + \left( \frac{\partial^2 E_\kappa}{\partial \x \partial \s}
 - \frac{\partial}{\partial \x} \left(\frac{\partial \C}{\partial \s} \la^k\right) \right)\ds
 + \left(\frac{\partial^2 E_M}{\partial \x^2} 
+ \frac{\partial^2 E_\kappa}{\partial \x^2} \right) \dx \\
&= M(\x^k - \tilde{\x}) +  h^2 \mu J^T(\hat{W}^k\cdot\s^k - I) V (W^k\s^k - J\x^k) 
	-  h^2 J^T(\hat{W}^k\cdot\s^k - I)V\la^k \\
&+  h^2 \mu \left( 
	J^T \hat{W} \cdot \left(V (W^k\s^k - J\x^k)	\right)
  + J^T(\hat{W^k}\cdot\s^k - I)  V W^k
   \right) \ds \\
&-  h^2 \left(J^T V(\hat{W}^k\cdot \la^k) \right) \ds \\
&+ \left( M +  h^2 \mu J^T(\hat{W}^k\cdot\s^k - I) V (\hat{W}^k\cdot\s^k - I)^T J \right) \dx.
\end{split}
\end{equation}
%&= \Hx\dx + \gx 
%- \sum_{K \in \Th} \left(
%J_K^T(\hat{W}_K^{k}\cdot \la_K^k) \ds_K +
%J_K^T(\hat{W}_K^{k}\cdot \s_K^k - I)\la_K^k
%\right)V_K

To simplify things we define the variables
\begin{align}
G &= J^T(\hat{W}^k\cdot\s^k - I)  \\
\res &= (W^k\s^k - J\x^k),
\end{align}
and the equation the equation for $\dx$ is now
\begin{equation}
\begin{split}
\frac{\partial \tilde{E}}{\partial \dx} 
&= \underbrace{M(\x^k - \tilde{\x}) +  h^2 \mu G V (\res - \la^k)}_\gx \\
&+ \underbrace{ h^2 \left( \mu \left(
	J^T V \hat{W} \cdot \left(V \res	\right)
  + G V W^k \right)
   - J^T(\hat{W}^k\cdot \la^k) \right)}_{\Jt^T} \ds \\
&+ \underbrace{\left( M +  h^2 \mu G V G^T \right)}_\Hx \dx.\\
&= \gx + \Jt^T \ds + \Hx \dx
\end{split}
\end{equation}

\subsection{Equation for $\ds$}
We start by differentiating $\tilde{E}$ with respect to $\ds$:

\begin{equation}
\begin{split}
\frac{\partial \tilde{E}}{\partial \ds} &=
 \frac{\partial E_\Psi}{\partial \s} + \frac{\partial E_\kappa}{\partial \s} -  \frac{\partial \El}{\partial \s}
  + \left( \frac{\partial^2 E_\kappa}{\partial \x \partial \s}
  - \frac{\partial}{\partial \x} \left(\frac{\partial \C}{\partial \s} \la^k\right) \right)\dx
    + \left(\frac{\partial^2 E_\Psi}{\partial \s^2}
    + \frac{\partial^2 E_\kappa}{\partial \s^2} \right) \ds \\
&=  h^2 \left( \frac{\partial \Psi}{\partial \s} + \mu {W^k}^T V (W^k\s^k - J\x^k) - {W^k}^TV\la^k \right. \\
&+ \mu \left( 
	J^T \hat{W} \cdot \left(V (W^k\s^k - J\x^k)	\right)
  + J^T(\hat{W^k}\cdot\s^k - I)  V W^k
   \right) \dx \\
&- \left( J^T(\hat{W}^k\cdot \la^k) \right) \dx \\
&+ \left. \left(\frac{\partial^2 \Psi}{\partial \s^2} + \mu{W^k}^T V {W^k} \right) \ds \right),
\end{split}
\end{equation}
and now substituting in some variables:
\begin{equation}
\begin{split}
\frac{\partial \tilde{E}}{\partial \ds} 
&= \underbrace{h^2 \left( \frac{\partial \Psi}{\partial \s} + \mu {W^k}^T V (\res - \la^k) \right)}_\gs \\
&+ \underbrace{h^2 \left( \mu \left(
	J^T V \hat{W} \cdot \left(V \res	\right)
  + G V W^k \right)
   - J^T(\hat{W}^k\cdot \la^k) \right)^T}_{\Jt} \dx \\
&+ \underbrace{h^2 \left(\frac{\partial^2 \Psi}{\partial \s^2} + \mu{W^k}^T V {W^k} \right)}_\Hs \ds \\
&= \gs + \Jt \dx + \Hs \ds.
\end{split}
\end{equation}


\subsection{Dual Energy}
To get an update rule for $\la$ we further modify our energy by adding a quadratic penalty $\frac{1}{2}||\la - \la^k||^2$. Holding $\x$ and $\s$ fixed, our energy in terms of only $\la$ is
\begin{equation}
E(\la) = \la^T V \C (\x^k, \s^k) + \frac{1}{2\kappa} ||\la - \la^k||_V^2
\end{equation}
For $\la = \la^k + \dl$, and differentiating with respect to $\dl$ we have
\begin{equation}
\dl = -\kappa \C(\x^k,\s^k)
\end{equation}


\subsection{System of Equations}
Using the equations for $\ds$ and $\dx$, we can now form a system of equations:

\begin{equation}
\begin{pmatrix}
\Hx & \Jt^T \\
\Jt & \Hs  \\
\end{pmatrix}
\begin{pmatrix}
\dx \\
\ds
\end{pmatrix} =
\begin{pmatrix}
-\gx \\
-\gs \\
\end{pmatrix}.
\end{equation}

\input{sqp.tex}

\end{document}

