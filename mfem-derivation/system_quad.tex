
\section{System of Equations}
Now to setup our system of equations, we differentiate our energy with respect to the $\delta$-variables and set equal to zero. We switch back to vector notation and make $K$ a subscript to simplify the notation.

\subsection{Equation for $\ds$}
We start by differentiating $\tilde{E} = E_M + \tilde{E}_\Psi + \tilde{E}_\Lambda$ with respect to $\ds$:
\begin{equation}
\begin{split}
\frac{\partial \tilde{E}^K}{\partial \ds_K} &= \frac{\partial \tilde{E}^K_\Psi}{\partial \ds_K} - \frac{\partial \tilde{E}^K_\Lambda}{\partial \ds_K} \\
&= g_K^t + H_K^t \ds_K - {W_K^t}^T (\la_K^t + \dl_K) - (\hat{W}_K^{t}\cdot \la_K^t)^T J_K \dx
\end{split}
\end{equation}
where $(\hat{W}_K^{t}\cdot \la_K^t)$ performs a reduction over the middle index of $\hat{W}^K_{ijk}$. Setting this derivative equal to zero and solving for $\ds_K$ gives
\begin{equation}
\ds_K = {H_K^t}^{-1} \left( {W_K^t}^T (\la_K^t + \dl_K) + (\hat{W}_K^{t}\cdot \la_K^t)^T J_K \dx - g_K^t \right).
\end{equation}

\subsection{Equation for $\dl$}
In the same fashion we differentiate $\tilde{E}$ with respect to $\dl$:

%To simplify our system of equations we substitute the solution for $\ds$ into into $\tilde{E}$ so that we end up with a KKT system solving for $\dx$ and $\dl$. We first note that
%\begin{equation}
%\frac{\partial \ds_K}{\partial \dl_K} = W_K^t{H_K^t}^{-1},
%\end{equation}
%so now we write
%\begin{equation}
%\begin{split}
%\frac{\partial \tilde{E}^K}{\partial \dl_K} &= \frac{\partial \tilde{E}^K_\Psi}{\partial \ds_K} - \frac{\partial \tilde{E}^K_\Lambda}{\partial \ds_K} \\
%&= W_K^t{H_K^t}^{-1} \left( g_K^t + H_K^t \ds_K \right) 
%- {W_K^t}^T (\la_K^t + \dl_K) - (\hat{W}_K^{t}\cdot \la_K^t)^T J_K \dx
%\end{split}
%\end{equation}
\begin{equation}
\begin{split}
\frac{\partial \tilde{E}^K}{\partial \dl_K} &= - \frac{\partial \tilde{E}^K_\Lambda}{\partial \dl_K} \\
&= -\frac{\partial \El^K}{\partial \la_K} - \frac{\partial^2 \El^K}{\partial \s_K \partial \la_K}\ds - \frac{\partial^2 \El^K}{\partial \x \partial \la_K}\dx \\
&= (J_K\x^t - W_K^ts_K^t) - W_K^t \ds - (\hat{W}_K^{t}\cdot \s_K^t - I)^T J_K \dx \\
&= (J_K(\x^t + \dx) - W_K^t (s_K^t + \ds_K)) - (\hat{W}_K^{t}\cdot \s_K^t)^T J_K \dx \\
\end{split}
\end{equation}
where $(\hat{W}_K^{t}\cdot \s_K^t)$ performs a reduction over the last index of $\hat{W}^K_{ijk}$.

\subsection{Equation for $\dx$}
Last we differentiate $\tilde{E}$ with respect to $\dx$ (we omit $\frac{\partial^2 \El^K}{ \partial \x^2} \dx$ for now):

\begin{equation}
\begin{split}
\frac{\partial \tilde{E}}{\partial \dx} &= \frac{\partial E_M }{\partial \dx} - \sum_{K \in \Th} \left(
  \frac{\partial \tilde{E}^K_\Lambda}{\partial \x} 
+ \frac{\partial^2 \El^K}{\partial \la_K \partial \x} \dl_K
+ \frac{\partial^2 \El^K}{\partial \s_K  \partial \x} \ds_K
\right) V_K \\
&=  \frac{1}{h^2}M(\dx - h\dot{\x}^t - h^2 \fext) \\
&- \sum_{K \in \Th} \left(
J_K^T(\hat{W}_K^{t}\cdot \s_K^t - I)(\la_K^t + \dl_K) +
J_K^T(\hat{W}_K^{t}\cdot \la_K^t) \ds_K
\right)V_K
\end{split}
\end{equation}

\subsection{System of Equations}
To build the system of equations we define some variables to keep things neat:
\begin{align}
G &= J^w - \sum_{K \in \Th} {P_K^\la}^T \left((\hat{W}_K^{t}\cdot \s_K^t)^T J_K^w \right) \\
D &= -\sum_{K \in \Th} {P_K^\la}^T  W_K^t P_K^\s\\
F &= - \sum_{K \in \Th} {P_K^\s}^T \left((\hat{W}_K^{t}\cdot \la_K^t)^T J_K^w \right)
\end{align}
where $J^w$ is the volume weighted Jacobian, and $P_K^\la \in \R^{9 \times 9n_e}$ and $P_K^\s \in \R^{6 \times 6n_e}$ are selection matrics for the $K$-th set of Lagrange multipliers and deformation variables, respectively. Additionally $H$ is the block diagonal Hessian for $s^t$. We form the system by setting each of the derivatives with respect to the $\delta$-variables equal to zero and get

\begin{equation}
\begin{pmatrix}
\frac{1}{h^2}M & F^T & G^T \\
F & H & D^T\\
G & D & 0
\end{pmatrix}
\begin{pmatrix}
\dx \\
\ds \\
\dl
\end{pmatrix} =
\begin{pmatrix}
\frac{1}{h^2}M\gx - G^T \la^t \\
 -g^t - D^T \la^t \\
-J^w\x^t -D \s^t 
\end{pmatrix}.
\end{equation}

Next, to get this thing in a KKT-like form we substitute the solution for the $\ds$ into the other equations. So we have
\begin{equation}
\ds = H^{-1}\left(-g^t - D^T(\la^t + \dl) - F\dx \right),
\end{equation}
and sorry cause it's about to get a little ugly, but for the first set of equations we have
\begin{equation*}
M\dx + F^TH^{-1}\left(-\gs - D^T(\la^t + \dl) - F\dx \right) +G^T \dl = \frac{1}{h^2}M\gx - G^T\la^t
\end{equation*}
and collect terms to get
\begin{equation}
(M - F^TH^{-1}F)\dx + (G^T - F^TH^{-1}D^T)\dl = 
\frac{1}{h^2}M\gx + F^TH^{-1}\gs + (F^TH^{-1}D^T - G)\la^t.
\end{equation}
I promise it gets cleaner, but next we substitute the solution for $\ds$ into the equations for $\dl$:
\begin{equation*}
G\dx + DH^{-1}\left(-\gs - D^T(\la^t + \dl) - F\dx\right) = -J^w\x^t - D\s^t,
\end{equation*}
and collect terms so that we have
\begin{equation}
(G - DH^{-1}F)\dx - DH^{-1}D^T\dl = -J^w\x^t + D(H^{-1}\gs - s^t + H^{-1}D^T\la^t).
\end{equation}
Before moving the equations back into matrix form, we define the following variables:
\begin{align*}
\tilde{M} &= (\frac{1}{h^2}M - F^TH^{-1}F) \\
\tilde{J} &= (G - DH^{-1}F). \\
\end{align*}

Now our final system of equations for a single Newton step is
\begin{equation}
\begin{pmatrix}
\tilde{M} & \tilde{J}^T \\
\tilde{J} & -DH^{-1}D^T 
\end{pmatrix}
\begin{pmatrix}
\dx \\
\dl
\end{pmatrix} =
\begin{pmatrix}
\frac{1}{h^2}M\gx + F^TH^{-1}\gs + (F^TH^{-1}D^T - G^T)\la^t \\
-J^w\x^t + D(H^{-1}\gs - s^t + H^{-1}D^T\la^t)
\end{pmatrix}.
\end{equation}